<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>// Place global declarations here.
//typedef
typedef int[0,1] EnemyType; //0 -&gt; Circle, 1 -&gt; Square
const EnemyType CIRCLE = 0;
const EnemyType SQUARE = 1;
typedef int[0,2] TurretType;
const TurretType BASIC  =  0;
const TurretType CANNON =  1;
const TurretType SNIPER =  2;

//struct
typedef struct {
    int x;
    int y;
} Coordinate;
const Coordinate SPAWN_POS = { 0, 0};
const Coordinate MAIN_TOWER_POS = { 15, 4};

typedef struct {
    bool active;
    EnemyType type;
    Coordinate pos;
    int spawnTime;  //Time when enemy spawned (for targeting priority)
} Enemy;



// game data
const int NUM_PATH = 5;
const int MAX_PATH_LEN = 14;
const int PATHS_LEN[NUM_PATH] = { 12, 6, 14, 8, 8 };
const Coordinate PATHS[5][MAX_PATH_LEN] = {
    { {  0, 0 }, {  0, 1 }, {  0, 2 }, {  0, 3 }, {  0, 4 }, {  1, 4 }, {  2,  4 }, {  3,  4 }, {  4,  4 }, {  5,  4 }, {  6,  4 }, {  7,  4 }, { -1, -1 }, { -1, -1 } },
    { {  7, 5 }, {  7, 6 }, {  7, 7 }, {  8, 7 }, {  9, 7 }, { 10, 7 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 } },
    { {  7, 3 }, {  7, 2 }, {  7, 1 }, {  8, 1 }, {  9, 1 }, { 10, 1 }, { 11,  1 }, { 12,  1 }, { 13,  1 }, { 14,  1 }, { 15,  1 }, { 15,  2 }, { 15,  3 }, { 15,  4 } },
    { { 11, 7 }, { 12, 7 }, { 13, 7 }, { 14, 7 }, { 15, 7 }, { 15, 6 }, { 15,  5 }, { 15,  4 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 } },
    { { 10, 6 }, { 10, 5 }, { 10, 4 }, { 11, 4 }, { 12, 4 }, { 13, 4 }, { 14,  4 }, { 15,  4 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 }, { -1, -1 } }
};
const int TURRETS_POS_LEN = 7;
const Coordinate TURRETS_POS[TURRETS_POS_LEN] = {
    { 2, 3 }, { 5, 5 }, { 8, 2 }, { 8, 6 }, { 11, 5 }, { 14, 2 }, { 14, 6 }
};

const int CIRCLE_SPEED = 1;
const int CIRCLE_HEALTH = 10;
const int CIRCLE_DAMAGE = 2;
const int SQUARE_SPEED = 3;
const int SQUARE_HEALTH = 20;
const int SQUARE_DAMAGE = 4;
const int CIRCLE_SPAWN_TIME = 2;
const int SQUARE_SPAWN_TIME = 3;
const int BASIC_RANGE       =  2;
const int BASIC_FIRE_SPEED  =  2;
const int BASIC_DAMAGE      =  2;
const int CANNON_RANGE      =  1;
const int CANNON_FIRE_SPEED =  7;
const int CANNON_DAMAGE     =  5;
const int SNIPER_RANGE      =  4;
const int SNIPER_FIRE_SPEED = 20;
const int SNIPER_DAMAGE     =  8;
// game configuration

const int NUM_CIRCLES = 3;
const int NUM_SQUARES = 3;
const int NUM_ENEMIES = NUM_CIRCLES + NUM_SQUARES;
const int NUM_TURRETS = 1;
int mainTowerLife = 10;


//global state
Enemy enemies[NUM_ENEMIES];
//global channel
chan enemySpawning[NUM_ENEMIES];
chan turretPositioning[7];
chan enemyHit[NUM_ENEMIES][TurretType];
broadcast chan posUpdate;


bool isPath(Coordinate pos){
    //Vertical segments
    if(pos.x ==  0 &amp;&amp; 0&lt;=pos.y &amp;&amp; pos.y&lt;=4) return true;
    if(pos.x ==  7 &amp;&amp; 1&lt;=pos.y &amp;&amp; pos.y&lt;=7) return true;
    if(pos.x == 10 &amp;&amp; 4&lt;=pos.y &amp;&amp; pos.y&lt;=7) return true;
    if(pos.x == 15 &amp;&amp; 1&lt;=pos.y &amp;&amp; pos.y&lt;=7) return true;

    //Horizontal segments
    if(pos.y == 1 &amp;&amp;  7&lt;=pos.x &amp;&amp; pos.x&lt;=15) return true;
    if(pos.y == 4 &amp;&amp;  0&lt;=pos.x &amp;&amp; pos.x&lt;= 7) return true;
    if(pos.y == 4 &amp;&amp; 10&lt;=pos.x &amp;&amp; pos.x&lt;=15) return true;
    if(pos.y == 7 &amp;&amp;  7&lt;=pos.x &amp;&amp; pos.x&lt;=15) return true;

    return false;        
}



</declaration>
	<template>
		<name x="5" y="5">GameController</name>
		<declaration>// Place local declarations here.
int turretsPlaced = 0;
int circlesSpawned = 0;      //Track the number of circles that have been spawned
int squaresSpawned = 0;      //Track the number of squares that have been spawned
int enemiesSpawned = 0; 

clock circleSpawnTimer;      //Track circle spawn time
clock squareSpawnTimer;      //Track square spawn time


void placeTurret() {
    turretsPlaced += 1;
}

void spawnEnemy(EnemyType type) {
    enemies[enemiesSpawned].active = true;
    enemies[enemiesSpawned].type   = type;
    enemies[enemiesSpawned].pos    = SPAWN_POS;

    if(type == CIRCLE) {
        enemies[enemiesSpawned].spawnTime = circlesSpawned * CIRCLE_SPAWN_TIME;
        circlesSpawned += 1;
        circleSpawnTimer = 0;
    }
    else {
        enemies[enemiesSpawned].spawnTime = squaresSpawned * SQUARE_SPAWN_TIME;
        squaresSpawned += 1;
        squareSpawnTimer = 0;
    }

    enemiesSpawned += 1;
}</declaration>
		<location id="id0" x="-85" y="0">
			<name x="-127" y="17">Spawn_Turret</name>
			<committed/>
		</location>
		<location id="id1" x="340" y="0">
			<name x="195" y="8">Spawn_Enemy</name>
			<label kind="invariant" x="8" y="-255">(circlesSpawned==NUM_CIRCLES || circleSpawnTimer&lt;=CIRCLE_SPAWN_TIME) &amp;&amp;
(squaresSpawned==NUM_SQUARES || squareSpawnTimer&lt;=SQUARE_SPAWN_TIME)</label>
		</location>
		<location id="id2" x="680" y="0">
			<name x="705" y="-25">End_Spawn</name>
		</location>
		<location id="id3" x="340" y="-102">
			<name x="330" y="-136">Spawn_Circle</name>
			<committed/>
		</location>
		<location id="id4" x="340" y="102">
			<name x="289" y="127">Spawn_Square</name>
			<committed/>
		</location>
		<init ref="id0"/>
		<transition id="id5">
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="-255" y="-102">turretsPlaced&lt;NUM_TURRETS &amp;&amp; NUM_TURRETS &gt; 0</label>
			<label kind="synchronisation" x="-153" y="-136">turretPositioning[turretsPlaced]!</label>
			<label kind="assignment" x="-110" y="-161">placeTurret()</label>
			<nail x="17" y="-76"/>
			<nail x="-187" y="-76"/>
		</transition>
		<transition id="id6">
			<source ref="id4"/>
			<target ref="id1"/>
			<nail x="238" y="68"/>
		</transition>
		<transition id="id7">
			<source ref="id1"/>
			<target ref="id4"/>
			<label kind="guard" x="391" y="119">squaresSpawned&lt;NUM_SQUARES &amp;&amp;
squareSpawnTimer==SQUARE_SPAWN_TIME</label>
			<label kind="synchronisation" x="433" y="93">enemySpawning[enemiesSpawned]!</label>
			<label kind="assignment" x="493" y="68">spawnEnemy(SQUARE)</label>
			<nail x="442" y="68"/>
		</transition>
		<transition id="id8">
			<source ref="id3"/>
			<target ref="id1"/>
			<nail x="238" y="-68"/>
		</transition>
		<transition id="id9">
			<source ref="id1"/>
			<target ref="id3"/>
			<label kind="guard" x="399" y="-144">circlesSpawned&lt;NUM_CIRCLES &amp;&amp;
circleSpawnTimer==CIRCLE_SPAWN_TIME</label>
			<label kind="synchronisation" x="399" y="-178">enemySpawning[enemiesSpawned]!</label>
			<label kind="assignment" x="484" y="-93">spawnEnemy(CIRCLE)</label>
			<nail x="442" y="-68"/>
		</transition>
		<transition id="id10">
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="guard" x="442" y="-59">circlesSpawned==NUM_CIRCLES &amp;&amp; squaresSpawned==NUM_SQUARES</label>
		</transition>
		<transition id="id11">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="-25" y="42">turretsPlaced==NUM_TURRETS</label>
		</transition>
	</template>
	<template>
		<name>EnemyTemplate</name>
		<parameter>int enemyId</parameter>
		<declaration>int speed;
int health;
int damage;
int step;
int path;
bool isMainTower;
clock spawnTimer;
clock moveTimer; 

void initEnemy() {
    if (enemies[enemyId].type == CIRCLE) {
        speed = CIRCLE_SPEED;
        health = CIRCLE_HEALTH;
        damage = CIRCLE_DAMAGE;
    } else {
        speed = SQUARE_SPEED;
        health = SQUARE_HEALTH;
        damage = SQUARE_DAMAGE;
    }
    enemies[enemyId].pos = SPAWN_POS;
    path = 0;
    step = 0;    
    moveTimer = 0;
    spawnTimer = 0;

}

void move(int i) {
    moveTimer = 0;
    if(step &lt; PATHS_LEN[path]-1){
        step = step + 1; //just increment else change path
    }
    else{
        if(path == 0 || path == 1) {
            path = path + 1 + i;
        }
        if(path == 1) {
            path = path + 2 + i;
        }
        step = 0;
    }
    enemies[enemyId].pos.x = PATHS[path][step].x;
    enemies[enemyId].pos.y = PATHS[path][step].y;
    isMainTower = enemies[enemyId].pos.x==MAIN_TOWER_POS.x &amp;&amp; enemies[enemyId].pos.y==MAIN_TOWER_POS.y;
}


void applyDamage(int enemyType) {
    if(enemies[enemyId].active) {
        if(enemies[enemyId].type == CIRCLE) {
            mainTowerLife-=CIRCLE_DAMAGE;
        }
        else {
            mainTowerLife-=SQUARE_DAMAGE;
        }
    }
    enemies[enemyId].active = false;
}

void receiveDamage(int damageReceived) {
    health -= damageReceived;
    if(health &lt;= 0) {
        enemies[enemyId].active = false;
    }
}</declaration>
		<location id="id12" x="-204" y="0">
			<name x="-272" y="-59">Not_Spawned</name>
		</location>
		<location id="id13" x="102" y="0">
			<name x="92" y="-34">Waiting</name>
			<label kind="invariant" x="17" y="161">moveTimer&lt;=speed</label>
		</location>
		<location id="id14" x="476" y="0">
			<name x="466" y="-34">Moving</name>
			<committed/>
		</location>
		<location id="id15" x="952" y="0">
			<name x="942" y="-34">End</name>
		</location>
		<location id="id16" x="467" y="-340">
			<name x="457" y="-374">Hit</name>
			<committed/>
		</location>
		<init ref="id12"/>
		<transition id="id17">
			<source ref="id16"/>
			<target ref="id15"/>
			<label kind="guard" x="527" y="-195">isMainTower</label>
		</transition>
		<transition id="id18">
			<source ref="id15"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="970" y="-221">enemyHit[enemyId][SNIPER]?</label>
			<label kind="assignment" x="970" y="-204">receiveDamage(SNIPER_DAMAGE)</label>
			<nail x="1020" y="-408"/>
		</transition>
		<transition id="id19">
			<source ref="id15"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="485" y="-374">enemyHit[enemyId][CANNON]?</label>
			<label kind="assignment" x="485" y="-357">receiveDamage(CANNON_DAMAGE)</label>
			<nail x="986" y="-374"/>
		</transition>
		<transition id="id20">
			<source ref="id15"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="485" y="-357">enemyHit[enemyId][BASIC]?</label>
			<label kind="assignment" x="485" y="-340">receiveDamage(BASIC_DAMAGE)</label>
			<nail x="952" y="-340"/>
		</transition>
		<transition id="id21">
			<source ref="id16"/>
			<target ref="id13"/>
			<label kind="guard" x="212" y="-246">!isMainTower</label>
		</transition>
		<transition id="id22">
			<source ref="id13"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="-84" y="-221">enemyHit[enemyId][SNIPER]?</label>
			<label kind="assignment" x="-84" y="-204">receiveDamage(SNIPER_DAMAGE)</label>
			<nail x="-102" y="-408"/>
		</transition>
		<transition id="id23">
			<source ref="id13"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="-50" y="-204">enemyHit[enemyId][CANNON]?</label>
			<label kind="assignment" x="-50" y="-187">receiveDamage(CANNON_DAMAGE)</label>
			<nail x="-68" y="-374"/>
		</transition>
		<transition id="id24">
			<source ref="id13"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="120" y="-357">enemyHit[enemyId][BASIC]?</label>
			<label kind="assignment" x="120" y="-340">receiveDamage(BASIC_DAMAGE)</label>
			<nail x="102" y="-340"/>
		</transition>
		<transition id="id25">
			<source ref="id14"/>
			<target ref="id15"/>
			<label kind="guard" x="620" y="-34">isMainTower</label>
			<label kind="synchronisation" x="620" y="-68">posUpdate!</label>
			<label kind="assignment" x="544" y="8">applyDamage(enemies[enemyId].type)</label>
		</transition>
		<transition id="id26">
			<source ref="id14"/>
			<target ref="id13"/>
			<label kind="guard" x="272" y="110">!isMainTower</label>
			<label kind="synchronisation" x="289" y="76">posUpdate!</label>
			<nail x="476" y="102"/>
			<nail x="102" y="102"/>
		</transition>
		<transition id="id27">
			<source ref="id13"/>
			<target ref="id14"/>
			<label kind="select" x="288" y="-51">i : int[0,1]</label>
			<label kind="guard" x="280" y="-25">moveTimer==speed</label>
			<label kind="assignment" x="314" y="0">move(i)</label>
		</transition>
		<transition id="id28">
			<source ref="id12"/>
			<target ref="id13"/>
			<label kind="synchronisation" x="-153" y="-34">enemySpawning[enemyId]?</label>
			<label kind="assignment" x="-186" y="0">initEnemy()</label>
		</transition>
	</template>
	<template>
		<name>TurretTemplate</name>
		<parameter>int turretId, Coordinate pos, int type</parameter>
		<declaration>int fireRate; 
int damage;  
int range;    
int targetEnemy = -1; 
clock fireTimer;  

void setTurretStats() {
    if (type == BASIC) {
        fireRate = BASIC_FIRE_SPEED;
        damage = BASIC_DAMAGE;
        range = BASIC_RANGE;
    } else if (type == CANNON) {
        fireRate = CANNON_FIRE_SPEED;
        damage = CANNON_DAMAGE;
        range = CANNON_RANGE;
    } else {
        fireRate = SNIPER_FIRE_SPEED;
        damage = SNIPER_DAMAGE;
        range = SNIPER_RANGE;
    }
}
int distance(Coordinate pos1, Coordinate pos2) {
    return abs(pos1.x - pos2.x) + abs(pos1.y - pos2.y);
}

void findTarget() {
    Coordinate turretPos = pos;
    int minDistance = range + range; //Initialize with a large value
    int maxSpawnTime = -1; //For enemies at same distance
    int i;
    targetEnemy = -1;
    for ( i = 0; i &lt; NUM_ENEMIES; i++) {
        if (enemies[i].active) {
            int d = distance(turretPos, enemies[i].pos);
            if ( d &lt; minDistance || 
                (d == minDistance &amp;&amp; enemies[i].spawnTime &gt; maxSpawnTime) || 
                (d == minDistance &amp;&amp; enemies[i].spawnTime == maxSpawnTime &amp;&amp; enemies[i].type == SQUARE)
               ) {
                minDistance = d;
                maxSpawnTime = enemies[i].spawnTime;
                targetEnemy = i;
            }
        }
    }
}</declaration>
		<location id="id29" x="-782" y="0">
			<name x="-792" y="-34">Not_Placed</name>
		</location>
		<location id="id30" x="-408" y="0">
			<name x="-493" y="-51">Searching</name>
			<label kind="invariant" x="-476" y="68">fireTimer &lt;= fireRate</label>
		</location>
		<location id="id31" x="-408" y="-306">
			<name x="-418" y="-340">Waiting</name>
		</location>
		<location id="id32" x="34" y="0">
			<name x="-17" y="-93">Firing</name>
			<committed/>
		</location>
		<init ref="id29"/>
		<transition id="id33">
			<source ref="id32"/>
			<target ref="id30"/>
			<label kind="guard" x="-144" y="136">targetEnemy!=-1</label>
			<label kind="synchronisation" x="-272" y="187">enemyHit[targetEnemy][type]!</label>
			<label kind="assignment" x="-170" y="161">fireTimer=0</label>
			<nail x="-170" y="136"/>
		</transition>
		<transition id="id34">
			<source ref="id31"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-501" y="-170">posUpdate?</label>
		</transition>
		<transition id="id35">
			<source ref="id32"/>
			<target ref="id31"/>
			<label kind="guard" x="-187" y="-204">targetEnemy==-1</label>
		</transition>
		<transition id="id36">
			<source ref="id30"/>
			<target ref="id32"/>
			<label kind="guard" x="-331" y="-68">fireTimer==fireRate</label>
			<label kind="assignment" x="-272" y="-42">findTarget()</label>
		</transition>
		<transition id="id37">
			<source ref="id29"/>
			<target ref="id30"/>
			<label kind="synchronisation" x="-764" y="-17">turretPositioning[turretId]?</label>
			<label kind="assignment" x="-764" y="0">setTurretStats()</label>
		</transition>
	</template>
	<system>g = GameController();

typedef int[0, NUM_ENEMIES - 1] enemyId_t;                         //bounded integer type with values [1..enemyNumber]
EnemyProcess(const enemyId_t id) = EnemyTemplate(id); 
TurretProcess0 = TurretTemplate(0, TURRETS_POS[0], BASIC);
system g, EnemyProcess, TurretProcess0;</system>
	<queries>
		<query>
			<formula>A[] (deadlock imply forall (i : enemyId_t) EnemyProcess(i).End)
</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-02 09:09:24 +0200">
			</result>
		</query>
		<query>
			<formula>A&lt;&gt; forall(i : enemyId_t) (enemies[i].pos.x==MAIN_TOWER_POS.x &amp;&amp; enemies[i].pos.y==MAIN_TOWER_POS.y)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-02 09:09:28 +0200">
			</result>
		</query>
		<query>
			<formula>A[] (forall(i : enemyId_t) ((enemies[i].type == SQUARE &amp;&amp; EnemyProcess(i).Moving) imply EnemyProcess(i).spawnTimer&lt;=26*SQUARE_SPEED))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-02 09:09:26 +0200">
			</result>
		</query>
		<query>
			<formula>A[] (forall(i : enemyId_t) ((enemies[i].type == CIRCLE &amp;&amp; EnemyProcess(i).Moving) imply EnemyProcess(i).spawnTimer&lt;=26*CIRCLE_SPEED))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-02 09:09:29 +0200">
			</result>
		</query>
		<query>
			<formula>A[] forall(i : enemyId_t) isPath(enemies[i].pos)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-02 09:09:30 +0200">
			</result>
		</query>
	</queries>
</nta>
